FROM docker.io/library/centos:7

# æ›¿æ¢ä¸ºå½’æ¡£é•œåƒæºï¼ˆCentOS 7 å·² EOLï¼‰
RUN sed -i 's|^mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-*.repo && \
    sed -i 's|^#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo

# å®‰è£…å¿…è¦å·¥å…·å’Œç³»ç»Ÿå¼€å‘åº“
RUN yum install -y wget bzip2 && \
    yum groupinstall -y "Development Tools" && \
    yum install -y glibc-devel libstdc++-devel && \
    yum clean all

# åˆ›å»ºå·¥å…·é“¾å®‰è£…ç›®å½•
WORKDIR /tmp

# ä¸‹è½½é¢„ç¼–è¯‘çš„ GCC 13 å·¥å…·é“¾
RUN wget -q https://toolchains.bootlin.com/downloads/releases/toolchains/x86-64/tarballs/x86-64--glibc--bleeding-edge-2024.02-1.tar.bz2 \
    -O toolchain.tar.bz2 && \
    tar -xjf toolchain.tar.bz2 && \
    mv x86-64--glibc--bleeding-edge-2024.02-1 /opt/gcc-toolchain && \
    rm toolchain.tar.bz2

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PATH="/opt/gcc-toolchain/bin:${PATH}" \
    LD_LIBRARY_PATH="/opt/gcc-toolchain/lib:/opt/gcc-toolchain/lib64"

# ğŸ”§ ä¿®å¤ pthread.h çš„ include-fixed é—®é¢˜
RUN cd /opt/gcc-toolchain/lib/gcc/x86_64-buildroot-linux-gnu/13.2.0/include-fixed && \
    echo "=== ä¿®å¤å‰çš„ pthread.h ===" && \
    grep -n 'struct_timespec' pthread.h || true && \
    # å¤‡ä»½åŸæ–‡ä»¶
    cp pthread.h pthread.h.bootlin-original && \
    # æ›¿æ¢é—®é¢˜çš„ include ä¸ºç³»ç»Ÿçš„ time.h
    sed -i 's|^#include <bits/types/struct_timespec.h>|/* #include <bits/types/struct_timespec.h> */\n#include <time.h>|' pthread.h && \
    # åŒæ ·å¤„ç† __sigset_t.h å¯èƒ½çš„é—®é¢˜
    sed -i 's|^#include <bits/types/__sigset_t.h>|/* #include <bits/types/__sigset_t.h> */\n#include <signal.h>|' pthread.h && \
    echo "=== ä¿®å¤åçš„ pthread.h ===" && \
    grep -A 1 'struct_timespec\|__sigset_t' pthread.h | head -10

# ğŸ”§ ä¿®å¤ endian.h çš„é—®é¢˜ï¼ˆä¹‹å‰æµ‹è¯•ä¸­é‡åˆ°çš„ï¼‰
RUN if [ -f /opt/gcc-toolchain/lib/gcc/x86_64-buildroot-linux-gnu/13.2.0/include-fixed/bits/endian.h ]; then \
        echo "ä¿®å¤ bits/endian.h..." && \
        cd /opt/gcc-toolchain/lib/gcc/x86_64-buildroot-linux-gnu/13.2.0/include-fixed/bits && \
        mv endian.h endian.h.bootlin-original; \
    fi

# åˆ›å»º wrapper è„šæœ¬
RUN cd /opt/gcc-toolchain/bin && \
    # GCC wrapper
    printf '#!/bin/bash\nexec /opt/gcc-toolchain/bin/x86_64-linux-gcc.br_real --sysroot=/ -L/opt/gcc-toolchain/lib64 -L/opt/gcc-toolchain/lib -Wl,-rpath-link,/opt/gcc-toolchain/lib64:/opt/gcc-toolchain/lib "$@"\n' > gcc && \
    chmod +x gcc && \
    # G++ wrapper
    printf '#!/bin/bash\nexec /opt/gcc-toolchain/bin/x86_64-linux-g++.br_real --sysroot=/ -I/opt/gcc-toolchain/x86_64-buildroot-linux-gnu/include/c++/13.2.0 -I/opt/gcc-toolchain/x86_64-buildroot-linux-gnu/include/c++/13.2.0/x86_64-buildroot-linux-gnu -L/opt/gcc-toolchain/lib64 -L/opt/gcc-toolchain/lib -Wl,-rpath-link,/opt/gcc-toolchain/lib64:/opt/gcc-toolchain/lib "$@"\n' > g++ && \
    chmod +x g++ && \
    # åˆ›å»ºå…¶ä»–å·¥å…·çš„ç¬¦å·é“¾æ¥
    ln -sf gcc cc && \
    ln -sf g++ c++ && \
    ln -sf x86_64-linux-ar ar && \
    ln -sf x86_64-linux-as as && \
    ln -sf x86_64-linux-ld ld && \
    ln -sf x86_64-linux-nm nm && \
    ln -sf x86_64-linux-objcopy objcopy && \
    ln -sf x86_64-linux-objdump objdump && \
    ln -sf x86_64-linux-ranlib ranlib && \
    ln -sf x86_64-linux-strip strip

WORKDIR /workspace

# éªŒè¯å®‰è£…å’Œä¿®å¤
RUN gcc --version && g++ --version && \
    echo "=== éªŒè¯ä¿®å¤ ===" && \
    echo '#include <pthread.h>' | gcc -E -x c - > /dev/null 2>&1 && echo "pthread.h: OK" || echo "pthread.h: FAILED" && \
    echo "GCC 13 å·¥å…·é“¾å·²å®‰è£…å¹¶ä¿®å¤ï¼Œå¯ä»¥ä½¿ç”¨ std::span å’Œ std::ranges"
